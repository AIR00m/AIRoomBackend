name: CD

on:
  workflow_run:
    workflows: [ "CI" ]
    types: [ completed ]

concurrency:
  group: cd-${{ github.event.workflow_run.head_branch || github.ref_name || 'default' }}
  # cancel-in-progress: false  # ì§ë ¬ ì²˜ë¦¬(íì‰). ëª…ì‹œ ì•ˆ í•´ë„ ê¸°ë³¸ false

jobs:
  cd:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&            
        github.event.workflow_run.head_branch == 'develop'      
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ docker/ í´ë” ì „ì†¡
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "docker"
          target: "/home/ubuntu"

      - name: ğŸ“‚ rsyncë¡œ /compose/infra/ì— ë®ì–´ì“°ê¸°
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            mkdir -p /home/ubuntu/compose/infra
            rsync -avz --delete /home/ubuntu/docker/ /home/ubuntu/compose/infra/

      - name: ğŸ§© Infra ë¨¼ì € ì—…ë°ì´íŠ¸ (compose up -d, down ê¸ˆì§€)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            docker network create core-services-net || true
            cd /home/ubuntu/compose/infra
            docker compose pull || true
            docker compose up -d --force-recreate

      - name: ğŸš€ Blue-Green Deploy (Spring Boot) + Nginx ìŠ¤ìœ„ì¹˜ (ì§ë ¬ë½/íì‰)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -Eeuo pipefail

            # === ë°°í¬ ë½ (ìµœëŒ€ 15ë¶„ ëŒ€ê¸°) ===
            LOCKFILE=/var/lock/springboot-cd.lock
            sudo mkdir -p /var/lock || true
            exec 200>"$LOCKFILE"
            flock -w 900 200 || { echo "â³ ë‹¤ë¥¸ ë°°í¬ ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ(15m) â†’ ì¢…ë£Œ"; exit 1; }
            trap 'flock -u 200' EXIT
            # ==============================

            IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:latest

            echo "[+] í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ springboot ì»¨í…Œì´ë„ˆ í™•ì¸"
            RUNNING=$(docker ps --format '{{.Names}}' | grep -E '^springboot-(blue|green)$' | head -n1 || true)
            if [ "$RUNNING" = "springboot-blue" ]; then
              NEW_CONTAINER="springboot-green"
              OLD_CONTAINER="springboot-blue"
              NEW_PORT=8082
              OLD_PORT=8081
            else
              NEW_CONTAINER="springboot-blue"
              OLD_CONTAINER="springboot-green"
              NEW_PORT=8081
              OLD_PORT=8082
            fi

            echo "[ğŸ“„] ìš´ì˜ìš© application.yml ë³µì›"
            echo "${{ secrets.CD_YML }}" | base64 -d > /home/ubuntu/application.yml

            echo "[ğŸŒ] core-services-net ë³´ì¥"
            docker network create core-services-net >/dev/null 2>&1 || true

            echo "[â¬‡ï¸] ì´ë¯¸ì§€ Pull"
            docker pull $IMAGE

            # === ë™ì¼ ì´ë¯¸ì§€ë©´ ìŠ¤í‚µ(Idempotent) ===
            NEW_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE | awk -F'@' '{print $2}' || true)
            OLD_DIGEST=""
            if docker ps -a --format '{{.Names}}' | grep -q "^$OLD_CONTAINER$"; then
              OLD_IMAGE_ID=$(docker inspect --format='{{.Image}}' $OLD_CONTAINER 2>/dev/null || true)
              # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì˜ digest ì¶”ì¶œ(ì—†ì„ ìˆ˜ë„ ìˆìŒ)
              OLD_DIGEST=$(docker inspect --format='{{join .RepoDigests ","}}' $OLD_IMAGE_ID 2>/dev/null | grep -o 'sha256:[0-9a-f]\+' | head -n1 || true)
            fi

            if [ -n "$NEW_DIGEST" ] && [ -n "$OLD_DIGEST" ] && [ "$NEW_DIGEST" = "$OLD_DIGEST" ]; then
              echo "â„¹ï¸ ê¸°ì¡´ê³¼ ë™ì¼í•œ ì´ë¯¸ì§€(digest=$NEW_DIGEST) â†’ ë°°í¬ ìŠ¤í‚µ"
              exit 0
            fi
            # ====================================

            # í˜¹ì‹œ ì´ì „ ì‹¤íŒ¨ ì”ì¬ê°€ ìˆìœ¼ë©´ ì œê±°
            docker stop $NEW_CONTAINER >/dev/null 2>&1 || true
            docker rm   $NEW_CONTAINER >/dev/null 2>&1 || true

            echo "[ğŸ†•] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰: $NEW_CONTAINER (alias: springboot)"
            docker run -d --name $NEW_CONTAINER \
              --network core-services-net \
              --network-alias springboot \
              -p $NEW_PORT:8080 \
              -v /home/ubuntu/application.yml:/config/application.yml \
              -e "SPRING_CONFIG_LOCATION=file:/config/application.yml" \
              -e "SERVER_ADDRESS=0.0.0.0" \
              $IMAGE

            echo "[â³] Health check (Docker HEALTHCHECK ìƒíƒœë¡œ ëŒ€ê¸°)"
            # 5ë¶„ê¹Œì§€ ëŒ€ê¸° (5s x 60)
            HEALTH_OK=0
            for i in {1..60}; do
            STATUS=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{end}}' $NEW_CONTAINER 2>/dev/null || echo "")
            if [ "$STATUS" = "healthy" ]; then HEALTH_OK=1; break; fi
            echo "â± waiting health... ($i/60) status=$STATUS"; sleep 5
            done
            if [ "$HEALTH_OK" -ne 1 ]; then
              echo "âŒ Health check ì‹¤íŒ¨ â†’ ë¡¤ë°±"
              docker logs --tail=200 $NEW_CONTAINER || true
              docker stop $NEW_CONTAINER
              docker rm $NEW_CONTAINER || true
              exit 1
            fi
            echo "âœ… Health check ì„±ê³µ"

            echo "[ğŸ”€] Nginx í”„ë¡ì‹œ í¬íŠ¸ $OLD_PORT â†’ $NEW_PORT ìŠ¤ìœ„ì¹˜"
            sudo sed -i "s/localhost:$OLD_PORT/localhost:$NEW_PORT/" /etc/nginx/conf.d/reverse.conf
            sudo nginx -t && sudo systemctl reload nginx

            echo "[ğŸ§¹] ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            if docker ps -a --format '{{.Names}}' | grep -q "^$OLD_CONTAINER$"; then
            docker network disconnect core-services-net $OLD_CONTAINER >/dev/null 2>&1 || true
            docker stop $OLD_CONTAINER >/dev/null 2>&1 || true
            docker rm   $OLD_CONTAINER >/dev/null 2>&1 || true
            fi

            echo "[âœ…] ë°°í¬ ì™„ë£Œ: $NEW_CONTAINER on :$NEW_PORT"

      - name: ğŸ§½ ì´ë¯¸ì§€ ì •ë¦¬
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            docker image prune -f || true
