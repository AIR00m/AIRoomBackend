name: CD

on:
  workflow_run:
    workflows: [ "CI" ]
    types:
      - completed
    branches:
      - develop

jobs:
  cd:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
      - 
      - name: üöÄ SSH & Blue-Green Deploy with Nginx Dynamic Reload
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:latest
            
            echo "[+] ÌòÑÏû¨ Ïã§Ìñâ Ï§ëÏù∏ Ïª®ÌÖåÏù¥ÎÑà ÌôïÏù∏"
            RUNNING=$(docker ps --format '{{.Names}}' | grep springboot || true)
            if [ "$RUNNING" = "springboot-blue" ]; then
              NEW_CONTAINER="springboot-green"
              OLD_CONTAINER="springboot-blue"
              NEW_PORT=8082
              OLD_PORT=8081
            else
              NEW_CONTAINER="springboot-blue"
              OLD_CONTAINER="springboot-green"
              NEW_PORT=8081
              OLD_PORT=8082
            fi
            echo "[üìÑ] application.yml Î≥µÏõê (Ïö¥ÏòÅÏö©)"
            echo "${{ secrets.CD_YML }}" | base64 -d > /home/ubuntu/application.yml
            
            echo "[+] ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ: $NEW_CONTAINER"
            docker pull $IMAGE
            docker run -d --name $NEW_CONTAINER -p $NEW_PORT:8080 \
            -v /home/ubuntu/application.yml:/config/application.yml \
            -e "SPRING_CONFIG_LOCATION=classpath:/,file:/config/application.yml" \
            $IMAGE            
            
            echo "[‚è≥] Health check Ï§ë..."
            for i in {1..10}; do
              if curl -s http://localhost:$NEW_PORT/actuator/health | grep UP; then
                echo "‚úÖ Health check ÏÑ±Í≥µ"
                break
              fi
              echo "‚è± Waiting..."
              sleep 3
              if [ $i -eq 10 ]; then
                echo "‚ùå Health check Ïã§Ìå® ‚Üí Î°§Î∞±"
                docker stop $NEW_CONTAINER
                docker rm $NEW_CONTAINER
                exit 1
              fi
            done
            echo "[‚öôÔ∏è] Nginx ÌîÑÎ°ùÏãú Ìè¨Ìä∏ ÏàòÏ†ï ($NEW_PORT)"
            sudo sed -i "s/localhost:$OLD_PORT/localhost:$NEW_PORT/" /etc/nginx/conf.d/reverse.conf
            sudo nginx -t && sudo systemctl reload nginx
            echo "[üßπ] Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà Ï¢ÖÎ£å Î∞è ÏÇ≠Ï†ú: $OLD_CONTAINER"
            docker stop $OLD_CONTAINER || true
            docker rm $OLD_CONTAINER || true