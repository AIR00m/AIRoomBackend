name: CD

on:
  workflow_run:
    workflows: [ "CI" ]
    types: [ completed ]
    branches: [ develop ]


concurrency:
  group: cd-${{ github.event.workflow_run.head_branch || github.ref_name || 'default' }}
  # cancel-in-progress: false  # ì§ë ¬ ì²˜ë¦¬(íì‰). ê¸°ë³¸ false

jobs:
  cd:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'develop'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ docker/ í´ë” ì „ì†¡
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "docker"
          target: "/home/ubuntu"

      - name: ğŸ“‚ rsyncë¡œ /compose/infra/ì— ë®ì–´ì“°ê¸°
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          command_timeout: 30m
          script: |
            docker network create core-services-net || true
            mkdir -p /home/ubuntu/compose/infra
            rsync -avz --delete /home/ubuntu/docker/ /home/ubuntu/compose/infra/
            cd /home/ubuntu/compose/infra
            docker compose pull || true
            docker compose up -d --force-recreate

      - name: ğŸš€ Blue-Green Deploy (Spring Boot) + Nginx ìŠ¤ìœ„ì¹˜ (ì§ë ¬ë½/íì‰)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          command_timeout: 30m
          script: |
            set -Eeuo pipefail

            # === ë°°í¬ ë½ (ìµœëŒ€ 15ë¶„ ëŒ€ê¸°, ê¶Œí•œ ë³´ì •) ===
            sudo mkdir -p /var/lock || true
            sudo touch /var/lock/springboot-cd.lock || true
            sudo chown "$USER":"$USER" /var/lock/springboot-cd.lock || true
            exec 200>/var/lock/springboot-cd.lock
            flock -w 900 200 || { echo "â³ ë‹¤ë¥¸ ë°°í¬ ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ(15m) â†’ ì¢…ë£Œ"; exit 1; }
            trap 'flock -u 200' EXIT
            # =========================================

            IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:latest

            # ğŸ” í˜„ì¬ Nginxê°€ ë°”ë¼ë³´ëŠ” í¬íŠ¸ë¡œ ë¡¤ ê²°ì • (reverse.conf ì•ˆì˜ proxy_pass)
            CURRENT_PORT=$(grep -oE 'localhost:808[12]' /etc/nginx/conf.d/reverse.conf | head -n1 | cut -d: -f2 || true)
            if [ "$CURRENT_PORT" = "8081" ]; then
              # í˜„ì¬ 8081(blue) ì„œë¹„ìŠ¤ ì¤‘ â†’ green ì‹ ê·œ
              NEW_CONTAINER="springboot-green"; OLD_CONTAINER="springboot-blue"
              NEW_PORT=8082; OLD_PORT=8081
            else
              # í˜„ì¬ 8082(green) ë˜ëŠ” ë¯¸ì„¤ì • â†’ blue ì‹ ê·œ
              NEW_CONTAINER="springboot-blue"; OLD_CONTAINER="springboot-green"
              NEW_PORT=8081; OLD_PORT=8082
            fi

            echo "[ğŸ“„] ìš´ì˜ìš© application.yml ë³µì›"
            printf '%s' "${{ secrets.CD_YML }}" | base64 -d > /home/ubuntu/application.yml

            echo "[ğŸŒ] core-services-net ë³´ì¥"
            docker network create core-services-net >/dev/null 2>&1 || true

            echo "[â¬‡ï¸] ì´ë¯¸ì§€ Pull"
            docker pull "$IMAGE"

            # === ë™ì¼ ì´ë¯¸ì§€ë©´ ìŠ¤í‚µ (digest ìš°ì„ , í´ë°± ImageID) ===
            NEW_DIGEST="$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE" 2>/dev/null | awk -F'@' '{print $2}')"
            OLD_DIGEST=""; OLD_IMAGE_ID=""
            if docker ps -a --format '{{.Names}}' | grep -q "^$OLD_CONTAINER$"; then
              OLD_IMAGE_ID="$(docker inspect --format='{{.Image}}' "$OLD_CONTAINER" 2>/dev/null || true)"
              OLD_DIGEST="$(docker inspect --format='{{index .RepoDigests 0}}' "$OLD_IMAGE_ID" 2>/dev/null | awk -F'@' '{print $2}' || true)"
            fi

            if [ -n "$NEW_DIGEST" ] && [ -n "$OLD_DIGEST" ] && [ "$NEW_DIGEST" = "$OLD_DIGEST" ]; then
              echo "â„¹ï¸ ê¸°ì¡´ê³¼ ë™ì¼í•œ ì´ë¯¸ì§€(digest=$NEW_DIGEST) â†’ ë°°í¬ ìŠ¤í‚µ"
              exit 0
            fi

            if [ -z "$NEW_DIGEST" ] && [ -n "$OLD_IMAGE_ID" ]; then
              NEW_IMAGE_ID="$(docker inspect --format='{{.Id}}' "$IMAGE" 2>/dev/null || true)"
              if [ -n "$NEW_IMAGE_ID" ] && [ "$NEW_IMAGE_ID" = "$OLD_IMAGE_ID" ]; then
                echo "â„¹ï¸ ê¸°ì¡´ê³¼ ë™ì¼í•œ ì´ë¯¸ì§€(ImageID) â†’ ë°°í¬ ìŠ¤í‚µ"
                exit 0
              fi
            fi
            # ============================================

            # í˜¹ì‹œ ì´ì „ ì‹¤íŒ¨ ì”ì¬ê°€ ìˆìœ¼ë©´ ì œê±°
            docker stop "$NEW_CONTAINER" >/dev/null 2>&1 || true
            docker rm   "$NEW_CONTAINER" >/dev/null 2>&1 || true

            echo "[ğŸ†•] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰: $NEW_CONTAINER (alias: springboot)"
            docker run -d --name "$NEW_CONTAINER" \
              --network core-services-net \
              --network-alias springboot \
              -p $NEW_PORT:8080 \
              -v /home/ubuntu/application.yml:/config/application.yml \
              -e "SPRING_CONFIG_LOCATION=file:/config/application.yml" \
              -e "SERVER_ADDRESS=0.0.0.0" \
              "$IMAGE"

            # âœ… ë¶€íŒ… ì•ˆì •í˜• í—¬ìŠ¤ì²´í¬: liveness â†’ readiness, ìœ ì˜ˆ+ë°±ì˜¤í”„+í´ë°± í¬í•¨
            echo "[â³] Health check (phase1=liveness, phase2=readiness)"
            sleep 3

            HEALTH_OK=0

            CONTEXT_PATH=$(docker inspect --format='{{range .Config.Env}}{{println .}}{{end}}' "$NEW_CONTAINER" \
              | grep -E '^SERVER_SERVLET_CONTEXT_PATH=' | cut -d'=' -f2- || true)
            if [ -z "${CONTEXT_PATH:-}" ]; then CONTEXT_PATH=""; fi

            # Phase 1: LIVENESS
            LIVENESS_URL="http://localhost:$NEW_PORT${CONTEXT_PATH}/actuator/health/liveness"
            for i in {1..60}; do
              BODY=$(curl -fsS "$LIVENESS_URL" || true)
              if echo "$BODY" | grep -q '"status"\s*:\s*"UP"'; then
                echo "âœ… Liveness OK"; break
              fi
              if [ $((i % 6)) -eq 0 ]; then
                echo "[hint] ë¶€íŒ… ì¤‘ì¼ ìˆ˜ ìˆìŒ. ìµœê·¼ ë¡œê·¸:"; docker logs --tail=20 "$NEW_CONTAINER" || true
              fi
              echo "â± waiting liveness... ($i/60)"; sleep 3
            done

            # Phase 2: READINESS (ì ì§„ ë°±ì˜¤í”„)
            READINESS_URL="http://localhost:$NEW_PORT${CONTEXT_PATH}/actuator/health/readiness"
            ATTEMPTS=0; MAX_ATTEMPTS=60; SLEEP=3
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              ATTEMPTS=$((ATTEMPTS+1))
              BODY=$(curl -fsS "$READINESS_URL" || true)
              if echo "$BODY" | grep -q '"status"\s*:\s*"UP"'; then
                HEALTH_OK=1; echo "âœ… Readiness OK"; break
              fi
              # readiness ì—†ì„ ë•Œ í´ë°±: /health
              if [ $((ATTEMPTS % 5)) -eq 0 ]; then
                FB=$(curl -fsS "http://localhost:$NEW_PORT${CONTEXT_PATH}/actuator/health" || true)
                if echo "$FB" | grep -q '"status"\s*:\s*"UP"'; then
                  HEALTH_OK=1; echo "âœ… Health OK (fallback)"; break
                fi
              fi
              echo "â± waiting readiness... ($ATTEMPTS/$MAX_ATTEMPTS)"; sleep $SLEEP
              if [ $SLEEP -lt 8 ] ; then SLEEP=$((SLEEP+1)); fi
            done

            if [ "$HEALTH_OK" -ne 1 ]; then
              echo "âŒ Health check ì‹¤íŒ¨ â†’ ë¡¤ë°±"
              docker logs --tail=200 "$NEW_CONTAINER" || true
              docker stop "$NEW_CONTAINER" >/dev/null 2>&1 || true
              docker rm   "$NEW_CONTAINER" >/dev/null 2>&1 || true
              exit 1
            fi

            # ğŸ”€ ì‹¤ì œ Nginx ìŠ¤ìœ„ì¹˜ (í˜„ì¬ í¬íŠ¸ì™€ ë‹¤ë¥¼ ë•Œë§Œ êµì²´)
            if grep -q "localhost:$OLD_PORT" /etc/nginx/conf.d/reverse.conf; then
              echo "[ğŸ”€] Nginx í”„ë¡ì‹œ í¬íŠ¸ $OLD_PORT â†’ $NEW_PORT ìŠ¤ìœ„ì¹˜"
              sudo sed -i "s/localhost:$OLD_PORT/localhost:$NEW_PORT/" /etc/nginx/conf.d/reverse.conf
              sudo nginx -t && sudo systemctl reload nginx
            else
              echo "â„¹ï¸ NginxëŠ” ì´ë¯¸ :$NEW_PORTë¥¼ ë°”ë¼ë³´ê³  ìˆìŒ â†’ ìŠ¤ìœ„ì¹˜ ìƒëµ"
            fi

            echo "[ğŸ§¹] ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            if docker ps -a --format '{{.Names}}' | grep -q "^$OLD_CONTAINER$"; then
              docker network disconnect core-services-net "$OLD_CONTAINER" >/dev/null 2>&1 || true
              docker stop "$OLD_CONTAINER" >/dev/null 2>&1 || true
              docker rm   "$OLD_CONTAINER" >/dev/null 2>&1 || true
            fi

            echo "[âœ…] ë°°í¬ ì™„ë£Œ: $NEW_CONTAINER on :$NEW_PORT"

      - name: ğŸ§½ ì´ë¯¸ì§€ ì •ë¦¬
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          command_timeout: 30m
          script: |
            docker image prune -f || true
