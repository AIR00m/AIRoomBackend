name: CD

on:
  workflow_run:
    workflows: [ "CI" ]
    types:
      - completed

jobs:
  cd:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ docker/ í´ë” ì „ì†¡
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "docker"
          target: "/home/ubuntu"

      - name: ğŸ“‚ rsyncë¡œ /compose/infra/ì— ë®ì–´ì“°ê¸°
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            mkdir -p /home/ubuntu/compose/infra
            rsync -avz --delete /home/ubuntu/docker/ /home/ubuntu/compose/infra/

      - name: ğŸ§© Infra ë¨¼ì € ì—…ë°ì´íŠ¸ (compose up -d, down ê¸ˆì§€)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            # core-services-net ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ ë³´ì¥
            docker network create core-services-net || true

            cd /home/ubuntu/compose/infra

            # ìµœì‹  ì´ë¯¸ì§€ ë°›ê¸°
            docker compose pull || true

            # ì¸í”„ë¼ ì¬ê¸°ë™ (down ê¸ˆì§€: ëª¨ë‹ˆí„°ë§ ê³µë°± ë°©ì§€)
            docker compose up -d --force-recreate

      - name: ğŸš€ Blue-Green Deploy (Spring Boot) + Nginx ìŠ¤ìœ„ì¹˜
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -Eeuo pipefail

            IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:latest

            echo "[+] í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ springboot ì»¨í…Œì´ë„ˆ í™•ì¸"
            RUNNING=$(docker ps --format '{{.Names}}' | grep -E '^springboot-(blue|green)$' || true)
            if [ "$RUNNING" = "springboot-blue" ]; then
              NEW_CONTAINER="springboot-green"
              OLD_CONTAINER="springboot-blue"
              NEW_PORT=8082
              OLD_PORT=8081
            else
              NEW_CONTAINER="springboot-blue"
              OLD_CONTAINER="springboot-green"
              NEW_PORT=8081
              OLD_PORT=8082
            fi

            echo "[ğŸ“„] ìš´ì˜ìš© application.yml ë³µì›"
            echo "${{ secrets.CD_YML }}" | base64 -d > /home/ubuntu/application.yml

            echo "[ğŸŒ] core-services-net ë„¤íŠ¸ì›Œí¬ ë³´ì¥"
            docker network create core-services-net >/dev/null 2>&1 || true

            echo "[â¬‡ï¸] ì•± ì´ë¯¸ì§€ Pull"
            docker pull $IMAGE

            echo "[ğŸ†•] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰: $NEW_CONTAINER (alias: springboot)"
            docker run -d --name $NEW_CONTAINER \
              --network core-services-net \
              --network-alias springboot \
              -p $NEW_PORT:8080 \
              -v /home/ubuntu/application.yml:/config/application.yml \
              -e "SPRING_CONFIG_LOCATION=file:/config/application.yml" \
              -e "SERVER_ADDRESS=0.0.0.0" \
              $IMAGE

            echo "[â³] Health check (Docker HEALTHCHECK ìƒíƒœë¡œ ëŒ€ê¸°)"
            # healthy ë  ë•Œê¹Œì§€ ìµœëŒ€ ~120ì´ˆ ëŒ€ê¸° (2s x 60)
            HEALTH_OK=0
            for i in {1..60}; do
              STATUS=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{end}}' $NEW_CONTAINER 2>/dev/null || echo "")
              if [ "$STATUS" = "healthy" ]; then
                HEALTH_OK=1
                break
              fi
              echo "â± waiting health... ($i/60) status=$STATUS"
              sleep 2
            done

            if [ "$HEALTH_OK" -ne 1 ]; then
              echo "âŒ Health check ì‹¤íŒ¨ â†’ ë¡¤ë°±"
              docker logs --tail=200 $NEW_CONTAINER || true
              docker stop $NEW_CONTAINER || true
              docker rm $NEW_CONTAINER || true
              exit 1
            fi
            echo "âœ… Health check ì„±ê³µ"

            echo "[ğŸ”€] Nginx í”„ë¡ì‹œ í¬íŠ¸ $OLD_PORT â†’ $NEW_PORT ìŠ¤ìœ„ì¹˜"
            sudo sed -i "s/localhost:$OLD_PORT/localhost:$NEW_PORT/" /etc/nginx/conf.d/reverse.conf
            sudo nginx -t && sudo systemctl reload nginx

            echo "[ğŸ§¹] ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            if docker ps -a --format '{{.Names}}' | grep -q "^$OLD_CONTAINER$"; then
              docker network disconnect core-services-net $OLD_CONTAINER || true
              docker stop $OLD_CONTAINER || true
              docker rm $OLD_CONTAINER || true
            fi

            echo "[âœ…] ë°°í¬ ì™„ë£Œ: $NEW_CONTAINER on :$NEW_PORT"

      - name: ğŸ§½ ì´ë¯¸ì§€ ì •ë¦¬
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            docker image prune -f || true
