name: CD

on:
  workflow_run:
    workflows: [ "CI" ]
    types:
      - completed

jobs:
  cd:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ”„ EC2ë¡œ infra ì„¤ì • íŒŒì¼ ë³µì‚¬
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: |
            docker/docker-compose.yml,
            docker/prometheus.yml,
            docker/logstash/logstash.conf,
            docker/grafana/provisioning/datasources/datasource.yml
          target: "/home/ubuntu/compose/infra"
          overwrite: true
          strip_components: 2  # âœ… docker/ í•˜ìœ„ êµ¬ì¡° ì •ë¦¬

      - name: ğŸš€ SSH & Blue-Green Deploy with Nginx + Infra ì¬ë°°í¬
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:latest

            echo "[+] í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸"
            RUNNING=$(docker ps --format '{{.Names}}' | grep springboot || true)
            if [ "$RUNNING" = "springboot-blue" ]; then
              NEW_CONTAINER="springboot-green"
              OLD_CONTAINER="springboot-blue"
              NEW_PORT=8082
              OLD_PORT=8081
            else
              NEW_CONTAINER="springboot-blue"
              OLD_CONTAINER="springboot-green"
              NEW_PORT=8081
              OLD_PORT=8082
            fi

            echo "[ğŸ“„] application.yml ë³µì› (ìš´ì˜ìš©)"
            echo "${{ secrets.CD_YML }}" | base64 -d > /home/ubuntu/application.yml

            echo "[+] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰: $NEW_CONTAINER"
            docker pull $IMAGE
            docker run -d --name $NEW_CONTAINER -p $NEW_PORT:8080 \
              -v /home/ubuntu/application.yml:/config/application.yml \
              -e "SPRING_CONFIG_LOCATION=file:/config/application.yml" \
              $IMAGE

            echo "[â³] Health check ì¤‘..."
            for i in {1..10}; do
              if curl -s http://localhost:$NEW_PORT/actuator/health | grep UP; then
                echo "âœ… Health check ì„±ê³µ"
                break
              fi
              echo "â± Waiting..."
              sleep 3
              if [ $i -eq 10 ]; then
                echo "âŒ Health check ì‹¤íŒ¨ â†’ ë¡¤ë°±"
                docker stop $NEW_CONTAINER
                docker rm $NEW_CONTAINER
                exit 1
              fi
            done

            echo "[âš™ï¸] Nginx í”„ë¡ì‹œ í¬íŠ¸ ìˆ˜ì • ($NEW_PORT)"
            sudo sed -i "s/localhost:$OLD_PORT/localhost:$NEW_PORT/" /etc/nginx/conf.d/reverse.conf
            sudo nginx -t && sudo systemctl reload nginx

            echo "[ğŸ§¹] ì´ì „ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì‚­ì œ: $OLD_CONTAINER"
            docker stop $OLD_CONTAINER || true
            docker rm $OLD_CONTAINER || true

            echo "[ğŸ”§] Infra ì„œë¹„ìŠ¤ êµ¬ì„± ì ìš©"
            cd /home/ubuntu/compose/infra

            echo "[ğŸ§¼] ê¸°ì¡´ Infra ì»¨í…Œì´ë„ˆ ì¢…ë£Œ"
            docker compose down --remove-orphans

            echo "[â™»ï¸] ë³€ê²½ëœ docker-compose.yml ë°˜ì˜"
            docker compose up -d --force-recreate